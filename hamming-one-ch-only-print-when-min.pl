#!/usr/bin/perl

use List::Util qw(min max);

################################################## define hamming distance (it is a fastest version i could find)
# XOR based Hamming distance subroutine
sub hd{
    return ($_[0] ^ $_[1]) =~ tr/\001-\255//;
}

################################################## define E1160, 4 versions for each 2-symbol

$E2 = "01101001101101001001101001001101001101101011001101000101101001001111001001101001101100001101101011001101010001101001101101001101001000101101001101101001001101101001101001110101000011101001001110001101101001001110010101001011101101001001101001101101001001100111000111010001101001100101001011101001101101001101001001101001100101101010010101101001101001001101010110101011000101001111001000110101101001101001001101001111001000101111001001101101001101001001101001101101001101001001101101000011101001100111000101101001011000101101101001001100111101001001001111001001110001101101001100101001001101101001001011101101001001100101101101001001001101101001110001101001101100011100011011000011100101101001001101001101101011001100110000111011001100001101110011000111000010101101101101010000111001101001101101001001001101001101101001100101001010101111000101011001001010101101011100101001001011100101110001101001001101100110001101011001101000101101001011001101001101001011101001100101011100101001101101001001011000101101011001101001110100001100101101011001101001101011001101000101101001110000101011001101001101101101001001001111000110001010110101110010110010100101011000111011";

# 0 -> R, 1-> Y
$E2_RY1 ="RYYRYRRYYRYYRYRRYRRYYRYRRYRRYYRYRRYYRYYRYRYYRRYYRYRRRYRYYRYRRYRRYYYYRRYRRYYRYRRYYRYYRRRRYYRYYRYRYYRRYYRYRYRRRYYRYRRYYRYYRYRRYYRYRRYRRRYRYYRYRRYYRYYRYRRYRRYYRYYRYRRYYRYRRYYYRYRYRRRRYYYRYRRYRRYYYRRRYYRYYRYRRYRRYYYRRYRYRYRRYRYYYRYYRYRRYRRYYRYRRYYRYYRYRRYRRYYRRYYYRRRYYYRYRRRYYRYRRYYRRYRYRRYRYYYRYRRYYRYYRYRRYYRYRRYRRYYRYRRYYRRYRYYRYRYRRYRYRYYRYRRYYRYRRYRRYYRYRYRYYRYRYRYYRRRYRYRRYYYYRRYRRRYYRYRYYRYRRYYRYRRYRRYYRYRRYYYYRRYRRRYRYYYYRRYRRYYRYYRYRRYYRYRRYRRYYRYRRYYRYYRYRRYYRYRRYRRYYRYYRYRRRRYYYRYRRYYRRYYYRRRYRYYRYRRYRYYRRRYRYYRYYRYRRYRRYYRRYYYYRYRRYRRYRRYYYYRRYRRYYYRRRYYRYYRYRRYYRRYRYRRYRRYYRYYRYRRYRRYRYYYRYYRYRRYRRYYRRYRYYRYYRYRRYRRYRRYYRYYRYRRYYYRRRYYRYRRYYRYYRRRYYYRRRYYRYYRRRRYYYRRYRYYRYRRYRRYYRYRRYYRYYRYRYYRRYYRRYYRRRRYYYRYYRRYYRRRRYYRYYYRRYYRRRYYYRRRRYRYRYYRYYRYYRYRYRRRRYYYRRYYRYRRYYRYYRYRRYRRYRRYYRYRRYYRYYRYRRYYRRYRYRRYRYRYRYYYYRRRYRYRYYRRYRRYRYRYRYYRYRYYYRRYRYRRYRRYRYYYRRYRYYYRRRYYRYRRYRRYYRYYRRYYRRRYYRYRYYRRYYRYRRRYRYYRYRRYRYYRRYYRYRRYYRYRRYRYYYRYRRYYRRYRYRYYYRRYRYRRYYRYYRYRRYRRYRYYRRRYRYYRYRYYRRYYRYRRYYYRYRRRRYYRRYRYYRYRYYRRYYRYRRYYRYRYYRRYYRYRRRYRYYRYRRYYYRRRRYRYRYYRRYYRYRRYYRYYRYYRYRRYRRYRRYYYYRRRYYRRRYRYRYYRYRYYYRRYRYYRRYRYRRYRYRYYRRRYYYRYY";

# 0 -> Y, 1-> R
$E2_RY2 = "YRRYRYYRRYRRYRYYRYYRRYRYYRYYRRYRYYRRYRRYRYRRYYRRYRYYYRYRRYRYYRYYRRRRYYRYYRRYRYYRRYRRYYYYRRYRRYRYRRYYRRYRYRYYYRRYRYYRRYRRYRYYRRYRYYRYYYRYRRYRYYRRYRRYRYYRYYRRYRRYRYYRRYRYYRRRYRYRYYYYRRRYRYYRYYRRRYYYRRYRRYRYYRYYRRRYYRYRYRYYRYRRRYRRYRYYRYYRRYRYYRRYRRYRYYRYYRRYYRRRYYYRRRYRYYYRRYRYYRRYYRYRYYRYRRRYRYYRRYRRYRYYRRYRYYRYYRRYRYYRRYYRYRRYRYRYYRYRYRRYRYYRRYRYYRYYRRYRYRYRRYRYRYRRYYYRYRYYRRRRYYRYYYRRYRYRRYRYYRRYRYYRYYRRYRYYRRRRYYRYYYRYRRRRYYRYYRRYRRYRYYRRYRYYRYYRRYRYYRRYRRYRYYRRYRYYRYYRRYRRYRYYYYRRRYRYYRRYYRRRYYYRYRRYRYYRYRRYYYRYRRYRRYRYYRYYRRYYRRRRYRYYRYYRYYRRRRYYRYYRRRYYYRRYRRYRYYRRYYRYRYYRYYRRYRRYRYYRYYRYRRRYRRYRYYRYYRRYYRYRRYRRYRYYRYYRYYRRYRRYRYYRRRYYYRRYRYYRRYRRYYYRRRYYYRRYRRYYYYRRRYYRYRRYRYYRYYRRYRYYRRYRRYRYRRYYRRYYRRYYYYRRRYRRYYRRYYYYRRYRRRYYRRYYYRRRYYYYRYRYRRYRRYRRYRYRYYYYRRRYYRRYRYYRRYRRYRYYRYYRYYRRYRYYRRYRRYRYYRRYYRYRYYRYRYRYRRRRYYYRYRYRRYYRYYRYRYRYRRYRYRRRYYRYRYYRYYRYRRRYYRYRRRYYYRRYRYYRYYRRYRRYYRRYYYRRYRYRRYYRRYRYYYRYRRYRYYRYRRYYRRYRYYRRYRYYRYRRRYRYYRRYYRYRYRRRYYRYRYYRRYRRYRYYRYYRYRRYYYRYRRYRYRRYYRRYRYYRRRYRYYYYRRYYRYRRYRYRRYYRRYRYYRRYRYRRYYRRYRYYYRYRRYRYYRRRYYYYRYRYRRYYRRYRYYRRYRRYRRYRYYRYYRYYRRRRYYYRRYYYRYRYRRYRYRRRYYRYRRYYRYRYYRYRYRRYYYRRRYRR";

# reverse complement of E2_RY1
$E2_RY3= reverse($E2_RY1);
$E2_RY3 =~  tr/RY/YR/;

# reverse complement of E2_RY2
$E2_RY4= reverse($E2_RY2);
$E2_RY4 =~  tr/RY/YR/;


# 0 -> W, 1-> S
$E2_WS1 ="WSSWSWWSSWSSWSWWSWWSSWSWWSWWSSWSWWSSWSSWSWSSWWSSWSWWWSWSSWSWWSWWSSSSWWSWWSSWSWWSSWSSWWWWSSWSSWSWSSWWSSWSWSWWWSSWSWWSSWSSWSWWSSWSWWSWWWSWSSWSWWSSWSSWSWWSWWSSWSSWSWWSSWSWWSSSWSWSWWWWSSSWSWWSWWSSSWWWSSWSSWSWWSWWSSSWWSWSWSWWSWSSSWSSWSWWSWWSSWSWWSSWSSWSWWSWWSSWWSSSWWWSSSWSWWWSSWSWWSSWWSWSWWSWSSSWSWWSSWSSWSWWSSWSWWSWWSSWSWWSSWWSWSSWSWSWWSWSWSSWSWWSSWSWWSWWSSWSWSWSSWSWSWSSWWWSWSWWSSSSWWSWWWSSWSWSSWSWWSSWSWWSWWSSWSWWSSSSWWSWWWSWSSSSWWSWWSSWSSWSWWSSWSWWSWWSSWSWWSSWSSWSWWSSWSWWSWWSSWSSWSWWWWSSSWSWWSSWWSSSWWWSWSSWSWWSWSSWWWSWSSWSSWSWWSWWSSWWSSSSWSWWSWWSWWSSSSWWSWWSSSWWWSSWSSWSWWSSWWSWSWWSWWSSWSSWSWWSWWSWSSSWSSWSWWSWWSSWWSWSSWSSWSWWSWWSWWSSWSSWSWWSSSWWWSSWSWWSSWSSWWWSSSWWWSSWSSWWWWSSSWWSWSSWSWWSWWSSWSWWSSWSSWSWSSWWSSWWSSWWWWSSSWSSWWSSWWWWSSWSSSWWSSWWWSSSWWWWSWSWSSWSSWSSWSWSWWWWSSSWWSSWSWWSSWSSWSWWSWWSWWSSWSWWSSWSSWSWWSSWWSWSWWSWSWSWSSSSWWWSWSWSSWWSWWSWSWSWSSWSWSSSWWSWSWWSWWSWSSSWWSWSSSWWWSSWSWWSWWSSWSSWWSSWWWSSWSWSSWWSSWSWWWSWSSWSWWSWSSWWSSWSWWSSWSWWSWSSSWSWWSSWWSWSWSSSWWSWSWWSSWSSWSWWSWWSWSSWWWSWSSWSWSSWWSSWSWWSSSWSWWWWSSWWSWSSWSWSSWWSSWSWWSSWSWSSWWSSWSWWWSWSSWSWWSSSWWWWSWSWSSWWSSWSWWSSWSSWSSWSWWSWWSWWSSSSWWWSSWWWSWSWSSWSWSSSWWSWSSWWSWSWWSWSWSSWWWSSSWSS";

# 0 -> S, 1-> W
$E2_WS2 = "SWWSWSSWWSWWSWSSWSSWWSWSSWSSWWSWSSWWSWWSWSWWSSWWSWSSSWSWWSWSSWSSWWWWSSWSSWWSWSSWWSWWSSSSWWSWWSWSWWSSWWSWSWSSSWWSWSSWWSWWSWSSWWSWSSWSSSWSWWSWSSWWSWWSWSSWSSWWSWWSWSSWWSWSSWWWSWSWSSSSWWWSWSSWSSWWWSSSWWSWWSWSSWSSWWWSSWSWSWSSWSWWWSWWSWSSWSSWWSWSSWWSWWSWSSWSSWWSSWWWSSSWWWSWSSSWWSWSSWWSSWSWSSWSWWWSWSSWWSWWSWSSWWSWSSWSSWWSWSSWWSSWSWWSWSWSSWSWSWWSWSSWWSWSSWSSWWSWSWSWWSWSWSWWSSSWSWSSWWWWSSWSSSWWSWSWWSWSSWWSWSSWSSWWSWSSWWWWSSWSSSWSWWWWSSWSSWWSWWSWSSWWSWSSWSSWWSWSSWWSWWSWSSWWSWSSWSSWWSWWSWSSSSWWWSWSSWWSSWWWSSSWSWWSWSSWSWWSSSWSWWSWWSWSSWSSWWSSWWWWSWSSWSSWSSWWWWSSWSSWWWSSSWWSWWSWSSWWSSWSWSSWSSWWSWWSWSSWSSWSWWWSWWSWSSWSSWWSSWSWWSWWSWSSWSSWSSWWSWWSWSSWWWSSSWWSWSSWWSWWSSSWWWSSSWWSWWSSSSWWWSSWSWWSWSSWSSWWSWSSWWSWWSWSWWSSWWSSWWSSSSWWWSWWSSWWSSSSWWSWWWSSWWSSSWWWSSSSWSWSWWSWWSWWSWSWSSSSWWWSSWWSWSSWWSWWSWSSWSSWSSWWSWSSWWSWWSWSSWWSSWSWSSWSWSWSWWWWSSSWSWSWWSSWSSWSWSWSWWSWSWWWSSWSWSSWSSWSWWWSSWSWWWSSSWWSWSSWSSWWSWWSSWWSSSWWSWSWWSSWWSWSSSWSWWSWSSWSWWSSWWSWSSWWSWSSWSWWWSWSSWWSSWSWSWWWSSWSWSSWWSWWSWSSWSSWSWWSSSWSWWSWSWWSSWWSWSSWWWSWSSSSWWSSWSWWSWSWWSSWWSWSSWWSWSWWSSWWSWSSSWSWWSWSSWWWSSSSWSWSWWSSWWSWSSWWSWWSWWSWSSWSSWSSWWWWSSSWWSSSWSWSWWSWSWWWSSWSWWSSWSWSSWSWSWWSSSWWWSWW";

# reverse complement of E2_WS1
$E2_WS3= reverse($E2_WS1);


# reverse complement of E2_WS2
$E2_WS4= reverse($E2_WS2);

$LE2=length($E2);	# 1160


################################################## reading input
if($#ARGV !=1){ 
 print "[.pl] chr(can be X) min_Hamming)dis(348)\n"; 
exit; }
$chr=$ARGV[0];
$minhd= $ARGV[1]; # 348 or 30% of 1160;


########## input seq file
if($chr == 23){ $f="GRCh38/chrX.fa.gz";
}else{ $f="GRCh38/chr".$chr.".fa.gz"; }
if(-e $f){ if($f =~ m/\.gz/){ open(IN,"gunzip -c $f | "); }else{ open(IN,"< $f"); } }

################# read the seq
$seq_tmp=""; $line=0; while($_=<IN>){ if($_ =~ m/^>/){} else{ chop; $_ =~ s/\s+//g; $seq_tmp .= $_; $line++; }}
$L=length($seq_tmp);

################# convert. uppercase
$seq_ry=uc($seq_tmp);
# well, in principle, should keep RY. maybe the difference is small
# $seq_ry=~ tr/URYKMSWBDHV/N/;
$seq_ry=~ tr/UKMSWBDHV/N/;
$seq_ry=~ tr/AG/R/;
$seq_ry=~ tr/CT/Y/;

$seq_ws=uc($seq_tmp);
$seq_ws=~ tr/URYKMBDHV/N/;
$seq_ws=~ tr/AT/W/;
$seq_ws=~ tr/GC/S/;


################# convert. uppercase
$i=0;
while( length($tmp= substr $seq_tmp, $i, $LE2)== $LE2 ){

 $tmp_ry = substr($seq_ry, $i, $LE2);
 $tmp_ws = substr($seq_ws, $i, $LE2);
 
 $tmphd = hd($tmp_ry, $E2_RY1);
 $tmphd2 = hd($tmp_ry, $E2_RY2);
 $tmphd3 = hd($tmp_ry, $E2_RY3);
 $tmphd4 = hd($tmp_ry, $E2_RY4);

 $tmphd5 = hd($tmp_ws, $E2_WS1);
 $tmphd6 = hd($tmp_ws, $E2_WS2);
 $tmphd7 = hd($tmp_ws, $E2_WS3);
 $tmphd8 = hd($tmp_ws, $E2_WS4);

 $minH = min($tmphd,$tmphd2,$tmphd3,$tmphd4,$tmphd5,$tmphd6,$tmphd7,$tmphd8);

 if($minH <= $minhd){
  print "$chr $i $tmphd $tmphd2 $tmphd3 $tmphd4 $tmphd5 $tmphd6 $tmphd7 $tmphd8\n";
  # print "(v1) $i $tmphd < $minhd\n";
  $pos1=$i;
 }

$i++;
}




